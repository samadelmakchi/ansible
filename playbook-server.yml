# کانفیگ و نصب ابزارهای سرور
- name: Configuring and installing server tools
  hosts: localhost
  become: true

  tasks:
    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ ساخت پوشه برنامه
    # ایجاد پوشه project_path اگر وجود نداشت
    - name: Ensure project_path directory exists
      ansible.builtin.file:
        path: "{{ project_path }}"
        state: directory
        mode: '0777'
      poll: 1

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ راه اندازی و ست کردن شکن
    - name: Set DNS for Shecan and configure systemd-resolved
      ansible.builtin.lineinfile:
        path: /etc/systemd/resolved.conf
        regexp: '^DNS='
        line: 'DNS=185.51.200.2 185.51.200.3'
        state: present
      poll: 1

    - name: Add FallbackDNS to /etc/systemd/resolved.conf
      ansible.builtin.lineinfile:
        path: /etc/systemd/resolved.conf
        regexp: '^FallbackDNS='
        line: 'FallbackDNS=8.8.8.8 1.1.1.1'
        state: present
      poll: 1

    - name: Restart systemd-resolved service
      ansible.builtin.systemd:
        name: systemd-resolved
        state: restarted
      poll: 1

    - name: Create symlink for /etc/resolv.conf to /run/systemd/resolve/resolv.conf
      ansible.builtin.file:
        src: /run/systemd/resolve/resolv.conf
        dest: /etc/resolv.conf
        state: link
      poll: 1

    - name: Test DNS with dig
      ansible.builtin.command:
        cmd: dig shecan.ir
      register: dig_result
      changed_when: false
      poll: 1

    - name: Print DNS test result
      ansible.builtin.debug:
        msg: "DNS test result: {{ dig_result.stdout }}"
      poll: 1

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ آپدیت سرور و نصب ابزارهای اولیه
    - name: Ensure python3-apt is installed (needed for apt module)
      ansible.builtin.apt:
        name: python3-apt
        state: present
        update_cache: true
      poll: 1

    - name: Update server and install essential tools
      ansible.builtin.apt:
        update_cache: true
        name:
          - cron
          - git
          - gzip
          - tar
          - curl
          - python3-pip
          - mysql-client
          - postgresql-client
        state: present
      poll: 1

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ نصب ابزارهای انسیبل
    # بررسی اینکه مجموعه community.docker نصب شده یا نه
    - name: Check if community.docker collection is installed
      ansible.builtin.command:
        cmd: ansible-galaxy collection list community.docker
      register: docker_collection_check
      changed_when: false
      failed_when: false
      poll: 1

    # اجرای اسکریپت نصب اگر مجموعه نصب نبود
    - name: Install community.docker collection using setup script if not present
      ansible.builtin.command:
        cmd: ./install-community-docker.sh
      when: docker_collection_check.rc != 0
      changed_when: true
      poll: 1

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ نصب داکر
    # بررسی اینکه آیا Docker نصب شده یا نه
    - name: Check if Docker is installed
      ansible.builtin.command: docker --version
      register: docker_check
      ignore_errors: true
      changed_when: false
      poll: 1

    # شناسایی نسخه اوبونتو و معماری (در صورت نبود Docker)
    - name: Check Ubuntu version and architecture
      ansible.builtin.shell: |
        CODENAME=$(lsb_release -cs)
        VERSION=$(lsb_release -rs)
        ARCHITECTURE=$(dpkg --print-architecture)
        echo "$CODENAME $VERSION $ARCHITECTURE"
      register: system_info
      changed_when: false
      poll: 1
      when: docker_check.rc != 0

    # دانلود فایل‌های Docker
    - name: Download Docker .deb files if not already downloaded
      ansible.builtin.shell: |
        DOWNLOAD_DIR="docker"
        mkdir -p "$DOWNLOAD_DIR"

        CODENAME="{{ system_info.stdout.split(' ')[0] }}"
        VERSION="{{ system_info.stdout.split(' ')[1] }}"
        ARCH="{{ system_info.stdout.split(' ')[2] }}"

        BASE_URL="https://download.docker.com/linux/ubuntu/dists/$CODENAME/pool/stable/$ARCH"
        FILES=(
          "containerd.io_1.7.27-1_${ARCH}.deb"
          "docker-ce_28.1.1-1~ubuntu.${VERSION}~${CODENAME}_${ARCH}.deb"
          "docker-ce-cli_28.1.1-1~ubuntu.${VERSION}~${CODENAME}_${ARCH}.deb"
          "docker-buildx-plugin_0.23.0-1~ubuntu.${VERSION}~${CODENAME}_${ARCH}.deb"
          "docker-compose-plugin_2.35.1-1~ubuntu.${VERSION}~${CODENAME}_${ARCH}.deb"
        )

        for FILE in "${FILES[@]}"; do
          if [ ! -f "$DOWNLOAD_DIR/$FILE" ]; then
            wget -O "$DOWNLOAD_DIR/$FILE" "$BASE_URL/$FILE"
          fi
        done
      args:
        executable: /bin/bash
      register: download_files
      changed_when: false
      poll: 1
      when: docker_check.rc != 0

    # نصب Docker از فایل‌های دانلود شده
    - name: Install Docker packages
      ansible.builtin.shell: |
        dpkg -i {{ playbook_dir }}/docker/*.deb
      args:
        executable: /bin/bash
      changed_when: true
      poll: 1
      when: docker_check.rc != 0

    # رفع مشکلات احتمالی وابستگی‌ها
    - name: Fix dependencies
      ansible.builtin.apt:
        name: docker-ce
        state: present
        update_cache: true
      poll: 1
      when: docker_check.rc != 0

    # شروع و فعال‌سازی سرویس Docker
    - name: Start Docker service
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: true
      poll: 1
      when: docker_check.rc != 0

    # چک کردن نسخه داکر
    - name: Check Docker version
      ansible.builtin.command:
        cmd: docker --version
      register: docker_version
      changed_when: false
      poll: 1

    # نمایش نسخه داکر
    - name: Show Docker version
      ansible.builtin.debug:
        msg: "Docker version: {{ docker_version.stdout }}"

    # چک کردن نسخه داکر کامپوز
    - name: Check Docker Compose version
      ansible.builtin.command:
        cmd: docker compose version
      register: docker_compose_version
      changed_when: false
      poll: 1

    # نمایش نسخه داکر کامپوز
    - name: Show Docker Compose version
      ansible.builtin.debug:
        msg: "Docker Compose version: {{ docker_compose_version.stdout }}"

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ داکر پایتون
    # چک کنید آیا ماژول docker در پایتون نصب شده است
    - name: Check if Python docker module is installed
      ansible.builtin.shell: /usr/bin/python3 -c "import docker" >/dev/null 2>&1 && echo OK || echo FAIL
      register: docker_module_status
      changed_when: false
      poll: 1

    # اگر نصب نبود، پکیج docker را نصب کنید
    - name: Install Python docker module if not present
      ansible.builtin.pip:
        name: docker
        executable: /usr/bin/pip3
      when: docker_module_status.stdout != "OK"
      poll: 1

    # اگر docker-compose نصب نبود، آن را نصب کنید
    - name: Install docker-compose if not present
      ansible.builtin.pip:
        name: docker-compose
        executable: /usr/bin/pip3
      when: ansible_facts.packages['python3-docker-compose'] is not defined
      poll: 1

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ تغییر داکر ایمیج
    # ساخت پوشه /etc/docker
    - name: Creating the /etc/docker folder
      become: true
      ansible.builtin.file:
        path: /etc/docker
        state: directory
        mode: '0755'

    # تنظیم ArvanCloud Mirror در فایل daemon.json
    - name: Setting up ArvanCloud Mirror in the daemon.json file
      become: true
      ansible.builtin.copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "insecure-registries" : ["https://docker.arvancloud.ir"],
            "registry-mirrors": ["https://docker.arvancloud.ir"]
          }
        mode: '0644'

    # خروج از لاگین Docker
    - name: Log out of Docker login
      ansible.builtin.command:
        cmd: docker logout
      register: docker_logout
      changed_when: false

    # ریستارت سرویس Docker
    - name: Restart the Docker service
      become: true
      ansible.builtin.systemd:
        name: docker
        state: restarted

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Bind9
    # تولید فایل زون Bind9 بر اساس اطلاعات inventory
    - name: Ensure Bind9 config directory exists
      ansible.builtin.file:
        path: "tools/etc/bind"
        state: directory
        mode: '0755'

    - name: Generate Bind9 zone file from template
      ansible.builtin.template:
        src: template/zonefile.j2
        dest: "tools/etc/bind/db.{{ domain }}"
        owner: root
        group: root
        mode: '0644'
      vars:
        soa_email: "admin.{{ domain | replace('.', '\\.') }}"
        ttl: 3600
        ns_record: "ns1.{{ domain }}."
        origin: "{{ domain }}"

    - name: Copy Bind9 named.conf
      ansible.builtin.copy:
        src: templates/bind9/named.conf
        dest: "tools/etc/bind/named.conf"
        owner: root
        group: root
        mode: '0644'

    - name: Generate bind9.yml from template
      ansible.builtin.template:
        src: template/bind9.yml.j2
        dest: tools/bind9.yml
        owner: root
        group: root
        mode: '0644'

    - name: Set up Bind9 using Docker Compose
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - bind9.yml
        state: present
        pull: always
        recreate: auto

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Traefik
    - name: Generate traefik.yml from template
      ansible.builtin.template:
        src: template/traefik.yml.j2
        dest: tools/traefik.yml
        owner: root
        group: root
        mode: '0644'

    - name: Set up Traefik using Docker Compose
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - traefik.yml
        state: present
        pull: always
        recreate: auto
      environment:
        PATH: "/root/.docker/cli-plugins:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

    # شبکه Docker traefik_reverse_proxy ایجاد کنید
    - name: Create traefik_reverse_proxy Docker network
      community.docker.docker_network:
        name: traefik_reverse_proxy
        state: present

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Portainer
    - name: Generate portainer.yml from template
      ansible.builtin.template:
        src: template/portainer.yml.j2
        dest: tools/portainer.yml
        owner: root
        group: root
        mode: '0644'
      when: install_portainer is true

    - name: Set up Portainer using Docker Compose
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - portainer.yml
        state: present
        pull: always
        recreate: auto
      when: install_portainer is true

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ SonarQube
    - name: Generate sonarqube.yml from template
      ansible.builtin.template:
        src: template/sonarqube.yml.j2
        dest: tools/sonarqube.yml
        owner: root
        group: root
        mode: '0644'
      when: install_sonarqube is true

    - name: Set up SonarQube using Docker Compose
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - sonarqube.yml
        state: present
        pull: always
        recreate: auto
      when: install_sonarqube is true

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Nexus
    - name: Generate nexus.yml from template
      ansible.builtin.template:
        src: template/nexus.yml.j2
        dest: tools/nexus.yml
        owner: root
        group: root
        mode: '0644'
      when: install_nexus is true

    - name: Set up Nexus using Docker Compose
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - nexus.yml
        state: present
        pull: always
        recreate: auto
      when: install_nexus is true

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ RabbitMQ
    - name: Generate rabbitmq.yml from template
      ansible.builtin.template:
        src: template/rabbitmq.yml.j2
        dest: tools/rabbitmq.yml
        owner: root
        group: root
        mode: '0644'
      when: install_rabbitmq is true

    - name: Set up RabbitMQ using Docker Compose
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - rabbitmq.yml
        state: present
        pull: always
        recreate: auto
      when: install_rabbitmq is true

    - name: Enable RabbitMQ management plugin
      community.docker.docker_container_exec:
        container: rabbitmq
        command: rabbitmq-plugins enable rabbitmq_management
      when: install_rabbitmq is true

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Apprise
    - name: Generate apprise.yml from template
      ansible.builtin.template:
        src: template/apprise.yml.j2
        dest: tools/apprise.yml
        owner: root
        group: root
        mode: '0644'
      when: install_apprise is true

    - name: Set up Apprise using Docker Compose
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - apprise.yml
        state: present
        pull: always
        recreate: auto
      when: install_apprise is true

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Uptime Kuma
    - name: Generate uptime_kuma.yml from template
      ansible.builtin.template:
        src: template/uptime_kuma.yml.j2
        dest: tools/uptime_kuma.yml
        owner: root
        group: root
        mode: '0644'
      when: install_uptime_kuma is true

    - name: Set up Uptime Kuma using Docker Compose
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - uptime_kuma.yml
        state: present
        pull: always
        recreate: auto
      when: install_uptime_kuma is true

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Splunk
    - name: Generate splunk.yml from template
      ansible.builtin.template:
        src: template/splunk.yml.j2
        dest: tools/splunk.yml
        owner: root
        group: root
        mode: '0644'
      when: install_splunk is true

    - name: Set up Splunk using Docker Compose
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - splunk.yml
        state: present
        pull: always
        recreate: auto
      when: install_splunk is true

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Grafana
    - name: Generate grafana.yml from template
      ansible.builtin.template:
        src: template/grafana.yml.j2
        dest: tools/grafana.yml
        owner: root
        group: root
        mode: '0644'
      when: install_grafana is true

    - name: Set up Grafana using Docker Compose
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - grafana.yml
        state: present
        pull: always
        recreate: auto
      when: install_grafana is true

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Pometheus
    - name: Generate prometheus.yml from template
      ansible.builtin.template:
        src: template/prometheus.yml.j2
        dest: tools/prometheus.yml
        owner: root
        group: root
        mode: '0644'
      when: install_prometheus is true

    - name: Set up Pometheus using Docker Compose
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - prometheus.yml
        state: present
        pull: always
        recreate: auto
      when: install_prometheus is true

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Dozzle
    - name: Generate dozzle.yml from template
      ansible.builtin.template:
        src: template/dozzle.yml.j2
        dest: tools/dozzle.yml
        owner: root
        group: root
        mode: '0644'
      when: install_dozzle is true

    - name: Set up Dozzle using Docker Compose
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - dozzle.yml
        state: present
        pull: always
        recreate: auto
      when: install_dozzle is true

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Shortcut
    - name: Generate shortcut.yml from template
      ansible.builtin.template:
        src: template/shortcut.yml.j2
        dest: tools/shortcut.yml
        owner: root
        group: root
        mode: '0644'
      when: install_shortcut is true

    - name: Set up Shortcut using Docker Compose
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - shortcut.yml
        state: present
        pull: always
        recreate: auto
      when: install_shortcut is true

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ DrawDB
    - name: Generate drawdb.yml from template
      ansible.builtin.template:
        src: template/drawdb.yml.j2
        dest: tools/drawdb.yml
        owner: root
        group: root
        mode: '0644'
      when: install_drawdb is true

    - name: Set up DrawDB using Docker Compose
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - drawdb.yml
        state: present
        pull: always
        recreate: auto
      when: install_drawdb is true

    # ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ Draw.io
    - name: Generate drawio.yml from template
      ansible.builtin.template:
        src: template/drawio.yml.j2
        dest: tools/drawio.yml
        owner: root
        group: root
        mode: '0644'
      when: install_drawio is true

    - name: Set up Draw.io using Docker Compose
      community.docker.docker_compose_v2:
        project_src: tools
        files:
          - drawio.yml
        state: present
        pull: always
        recreate: auto
      when: install_drawio is true
